---
import { getEntry, type CollectionEntry } from "astro:content"

import AudioPlayer from "./audio-player.astro"
import Pedal from "./pedal"
import PresetsSlider from "./presets-slider.astro"

import { DemoStateInitializer } from "./demo-state-initializer"

interface Props {
  presetSlug: CollectionEntry<"demos">["slug"]
}

const { presetSlug } = Astro.props

const {
  data: { presets },
}: CollectionEntry<"presets"> = await getEntry(
  "presets",
  `${presetSlug}.presets`
)

// Get all pedals from presets
const pedalsFromPresets = presets.reduce(
  (acc, { chain, comparison }) => [
    ...acc,
    ...(chain?.map(({ pedalSlug }) => pedalSlug) ?? []),
    ...(comparison?.map(({ pedalSlug }) => pedalSlug) ?? []),
  ],
  [] as string[]
)

// Add the current preset to the list of pedals if it's not a comparison
if (!presets.some(({ comparison }) => Boolean(comparison))) {
  pedalsFromPresets.unshift(presetSlug)
}

const pedals = [...new Set(pedalsFromPresets)]
---

<DemoStateInitializer client:load {presets} {pedals} />
<div class="flex flex-col gap-4">
  <AudioPlayer />
  <PresetsSlider {presets} />
</div>
<div class="mb-24 mt-8 flex items-end justify-center">
  {pedals.map((slug) => <Pedal slug={slug} />)}
  <!-- <Pedal slug={presetSlug} /> -->
</div>
